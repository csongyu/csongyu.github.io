<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"csongyu.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":330,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="日拱一卒，不期速成；道阻且长，行则将至">
<meta property="og:type" content="website">
<meta property="og:title" content="日拱一卒">
<meta property="og:url" content="https://csongyu.github.io/page/14/index.html">
<meta property="og:site_name" content="日拱一卒">
<meta property="og:description" content="日拱一卒，不期速成；道阻且长，行则将至">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Song Yu Chen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://csongyu.github.io/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>日拱一卒</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">日拱一卒</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://csongyu.github.io/posts/4e2102a6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Song Yu Chen">
      <meta itemprop="description" content="日拱一卒，不期速成；道阻且长，行则将至">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="日拱一卒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/4e2102a6.html" class="post-title-link" itemprop="url">Do we need to configure socketTimeout when using HikariCP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-23 00:00:00" itemprop="dateCreated datePublished" datetime="2023-02-23T00:00:00+08:00">2023-02-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="scenario">Scenario</h3>
<p><code>HikariCP</code> + <code>mariadb-java-client</code> +
<code>MySQL</code></p>
<p>Although the network or database has been restored, the application
will not restore itself, only after a restart.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.sql.SQLTransientConnectionException: HikariPool-<span class="number">1</span> - Connection is not available, request timed out after 30000ms.</span><br></pre></td></tr></table></figure>
<h3 id="thread-dump">Thread Dump</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;HikariPool-1 connection adder&quot;</span> ... runnable ...</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">    at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;xxx_QuartzSchedulerThread&quot;</span> ... waiting on condition ...</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (parking)</span><br><span class="line">    ...</span><br><span class="line">    at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)</span><br><span class="line">    at com.zaxxer.hikari.util.ConcurrentBag.borrow(ConcurrentBag.java:157)</span><br><span class="line">    at com.zaxxer.hikari.pool.HikariPool.getConnection(HikariPool.java:173)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;HikariPool-1 housekeeper&quot;</span> ... waiting on condition ...</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (parking)</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<h3 id="how-hikaricp-creates-connections">How HikariCP creates
connections</h3>
<p><code>main</code> thread call stack as follows:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|-com.zaxxer.hikari.HikariDataSource<span class="comment">#getConnection()</span></span><br><span class="line"> |-com.zaxxer.hikari.poolHikariPool<span class="comment">#getConnection(hardTimeout)</span></span><br><span class="line">  |-com.zaxxer.hikari.util.ConcurrentBag<span class="comment">#borrow(timeout, timeUnit)</span></span><br><span class="line">   |-com.zaxxer.hikari.pool.HikariPool<span class="comment">#addBagItem(waiting)</span></span><br></pre></td></tr></table></figure>
<p><code>addConnectionExecutor</code> is responsible for creating
connections, but it is a thread pool with only one thread, which means
creating connections is blocking and needs to be queued.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.zaxxer.hikari.pool.HikariPool</span></span><br><span class="line">...</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBagItem</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> waiting)</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">shouldAdd</span> <span class="operator">=</span> waiting - addConnectionQueue.size() &gt;= <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (shouldAdd) &#123;</span><br><span class="line">         <span class="comment">// corePoolSize=1, maximumPoolSize=1, workQueue=LinkedBlockingQueue</span></span><br><span class="line">         addConnectionExecutor.submit(POOL_ENTRY_CREATOR);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>HikariPool-1 connection adder</code> thread call stack as
follows:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">|-com.zaxxer.hikari.pool.HikariPool.PoolEntryCreator<span class="comment">#call()</span></span><br><span class="line"> |-com.zaxxer.hikari.pool.HikariPool<span class="comment">#createPoolEntry()</span></span><br><span class="line">  |-com.zaxxer.hikari.pool.PoolBase<span class="comment">#newPoolEntry()</span></span><br><span class="line">   |-com.zaxxer.hikari.pool.PoolBase<span class="comment">#newConnection()</span></span><br><span class="line">    |-com.zaxxer.hikari.util.DriverDataSource<span class="comment">#getConnection()</span></span><br><span class="line">     |-org.mariadb.jdbc.Driver<span class="comment">#connect(url, props)</span></span><br><span class="line">      |-org.mariadb.jdbc.MariaDbConnection<span class="comment">#newConnection(urlParser, globalInfo)</span></span><br><span class="line">       |-org.mariadb.jdbc.internal.util.Utils<span class="comment">#retrieveProxy(urlParser, globalInfo)</span></span><br><span class="line">        |-org.mariadb.jdbc.internal.protocol.AbstractConnectProtocol<span class="comment">#connectWithoutProxy()</span></span><br><span class="line">         |-org.mariadb.jdbc.internal.protocol.AbstractConnectProtocol<span class="comment">#createConnection(hostAddress, username)</span></span><br><span class="line">          |-org.mariadb.jdbc.internal.protocol.AbstractConnectProtocol<span class="comment">#createSocket(host, port, options)</span></span><br><span class="line">          |-org.mariadb.jdbc.internal.com.read.ReadInitialHandShakePacket<span class="comment">#ReadInitialHandShakePacket(reader)</span></span><br><span class="line">           |-org.mariadb.jdbc.internal.io.input.StandardPacketInputStream<span class="comment">#getPacket(reUsable)</span></span><br><span class="line">            |-org.mariadb.jdbc.internal.io.input.StandardPacketInputStream<span class="comment">#getPacketArray(reUsable)</span></span><br><span class="line">             |-org.mariadb.jdbc.internal.io.input.ReadAheadBufferedStream<span class="comment">#read(externalBuf, off, len)</span></span><br><span class="line">              |-org.mariadb.jdbc.internal.io.input.ReadAheadBufferedStream<span class="comment">#fillBuffer(minNeededBytes)</span></span><br><span class="line">               |-java.io.FilterInputStream<span class="comment">#read(b, off, len)</span></span><br><span class="line">                |-java.net.SocketInputStream<span class="comment">#read(b, off, length)</span></span><br><span class="line">                 |-java.net.SocketInputStream<span class="comment">#read(b, off, length, timeout)</span></span><br><span class="line">                  |-java.net.SocketInputStream<span class="comment">#socketRead(fd, b, off, len, timeout)</span></span><br><span class="line">                   |-java.net.SocketInputStream<span class="comment">#socketRead0(fd, b, off, len, timeout)</span></span><br></pre></td></tr></table></figure>
<p><code>org.mariadb.jdbc.internal.protocol.AbstractConnectProtocol#createSocket</code>
mehtod will establish a TCP connection through
<code>java.net.Socket</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xxx@xxx ~ % lsof -i tcp:3306</span><br><span class="line">COMMAND     PID       USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java      10015 chensongyu   95u  IPv6 0xe5897620744b2967      0t0  TCP localhost:64819-&gt;localhost:mysql (ESTABLISHED)</span><br><span class="line">com.docke 69423 chensongyu  115u  IPv6 0xe5897620744c2967      0t0  TCP *:mysql (LISTEN)</span><br><span class="line">com.docke 69423 chensongyu  122u  IPv6 0xe5897620744c3047      0t0  TCP localhost:mysql-&gt;localhost:64819 (ESTABLISHED)</span><br></pre></td></tr></table></figure>
<p>The default socketTimeout is 0, which means no timeout, and the
default connectTimeout is 30s.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.mariadb.jdbc.internal.protocol.AbstractConnectProtocol</span></span><br><span class="line">...</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Socket <span class="title function_">createSocket</span><span class="params">(<span class="keyword">final</span> String host, <span class="keyword">final</span> <span class="type">int</span> port, <span class="keyword">final</span> Options options)</span></span><br><span class="line">      <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    Socket socket;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="comment">// socketTimeout default is zero</span></span><br><span class="line">      <span class="keyword">if</span> (options.socketTimeout != <span class="literal">null</span>) &#123;</span><br><span class="line">        socket.setSoTimeout(options.socketTimeout);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// connectTimeout default is 30_000ms</span></span><br><span class="line">          socket.connect(sockAddr, options.connectTimeout);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">          <span class="keyword">throw</span> ioe;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>After the connection is established, parse the server greeting
packet.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.mariadb.jdbc.internal.com.read.ReadInitialHandShakePacket</span></span><br><span class="line">...</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ReadInitialHandShakePacket</span><span class="params">(<span class="keyword">final</span> PacketInputStream reader)</span></span><br><span class="line">      <span class="keyword">throws</span> IOException, SQLException &#123;</span><br><span class="line">    <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> reader.getPacket(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (buffer.getByteAt(<span class="number">0</span>) == ERROR) &#123;</span><br><span class="line">      <span class="type">ErrorPacket</span> <span class="variable">errorPacket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorPacket</span>(buffer);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(errorPacket.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="what-went-wrong">What went wrong</h3>
<p>Consider the network or database to be unstable at some point, your
application thread will get stuck in this
<code>java.net.SocketInputStream#socketRead0()</code> API until it has
completely read the response data. What's more serious is that
<code>addConnectionExecutor</code> has only one thread, which will
prevent the task <code>POOL_ENTRY_CREATOR</code> from creating new
connections, even if the network or database has returned to normal.</p>
<h3 id="how-to-fix">How to fix</h3>
<p>Configure <code>socketTimeout</code> on
<code>spring.datasource.url</code> property.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mariadb://localhost:3306/xxx?socketTimeout=60000</span></span><br></pre></td></tr></table></figure>
<h3 id="update">Update</h3>
<p><a
target="_blank" rel="noopener" href="https://www.theguardian.com/info/2019/dec/02/faster-postgresql-connection-recovery">Faster
PostgreSQL connection recovery</a></p>
<p><a
target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/Rapid-Recovery">Rapid
Recovery</a></p>
<blockquote>
<p>Unacknowledged TCP</p>
<p>The reason that HikariCP is powerless to recover connections that are
out of the pool is due to unacknowledged TCP traffic. TCP is a
synchronous communication scheme that requires "handshaking" from both
sides of the connection as packets are exchanged (<code>SYN</code> and
<code>ACK</code> packets).</p>
<p>When TCP communication is abruptly interrupted, the client
<em>or</em> server can be left awaiting the acknowledgement of a packet
that will never come. The connection is therefore "stuck", until an
operating system level TCP timeout occurs. This can be as long as
several hours, depending on the operating system TCP stack tuning.</p>
<p>TCP Timeouts</p>
<p>In order to avoid this condition, it is imperative that the
application configures the driver-level TCP <em>socket timeout</em> .
Each driver differs in how this timeout is set, but nearly all drivers
support it.</p>
<p>HikariCP <em>recommends</em> that the driver-level socket timeout be
set to (at least) 2-3x the longest running SQL transaction, or 30
seconds, whichever is longer. However, your own recovery time targets
should determine the appropriate timeout for your application.</p>
<p>See the specific database sections below for some common
configurations.</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://csongyu.github.io/posts/9580f9e1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Song Yu Chen">
      <meta itemprop="description" content="日拱一卒，不期速成；道阻且长，行则将至">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="日拱一卒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/9580f9e1.html" class="post-title-link" itemprop="url">Why does HikariCP default set keepaliveTime as zero as default</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-20 00:00:00" itemprop="dateCreated datePublished" datetime="2023-02-20T00:00:00+08:00">2023-02-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="hikaricp-keepalivetime"><a
target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>
keepaliveTime</h3>
<blockquote>
<p>keepaliveTime</p>
<p>This property controls how frequently HikariCP will attempt to keep a
connection alive, in order to prevent it from being timed out by the
database or network infrastructure. This value must be less than the
<code>maxLifetime</code> value. A "keepalive" will only occur on an idle
connection. When the time arrives for a "keepalive" against a given
connection, that connection will be removed from the pool, "pinged", and
then returned to the pool. The 'ping' is one of either: invocation of
the JDBC4 <code>isValid()</code> method, or execution of the
<code>connectionTestQuery</code>. Typically, the duration
out-of-the-pool should be measured in single digit milliseconds or even
sub-millisecond, and therefore should have little or no noticeable
performance impact. The minimum allowed value is 30000ms (30 seconds),
but a value in the range of minutes is most desirable. <em>Default: 0
(disabled)</em></p>
</blockquote>
<h3
id="always-check-the-connection-availability-when-calling-getconnection">Always
check the connection availability when calling getConnection()</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.zaxxer.hikari.pool.HikariPool</span></span><br><span class="line">...</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">aliveBypassWindowMs</span> <span class="operator">=</span> Long.getLong(<span class="string">&quot;com.zaxxer.hikari.aliveBypassWindowMs&quot;</span>, MILLISECONDS.toMillis(<span class="number">500</span>));</span><br><span class="line">...</span><br><span class="line">   <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> hardTimeout)</span> <span class="keyword">throws</span> SQLException</span><br><span class="line">   &#123;</span><br><span class="line">...</span><br><span class="line">         <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">PoolEntry</span> <span class="variable">poolEntry</span> <span class="operator">=</span> connectionBag.borrow(timeout, MILLISECONDS);</span><br><span class="line">            <span class="keyword">if</span> (poolEntry == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> currentTime();</span><br><span class="line">            <span class="keyword">if</span> (poolEntry.isMarkedEvicted() || (elapsedMillis(poolEntry.lastAccessed, now) &gt; aliveBypassWindowMs &amp;&amp; !isConnectionAlive(poolEntry.connection))) &#123;</span><br><span class="line">               closeConnection(poolEntry, poolEntry.isMarkedEvicted() ? EVICTED_CONNECTION_MESSAGE : DEAD_CONNECTION_MESSAGE);</span><br><span class="line">               timeout = hardTimeout - elapsedMillis(startTime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               metricsTracker.recordBorrowStats(poolEntry, startTime);</span><br><span class="line">               <span class="keyword">return</span> poolEntry.createProxyConnection(leakTaskFactory.schedule(poolEntry), now);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125; <span class="keyword">while</span> (timeout &gt; <span class="number">0L</span>);</span><br><span class="line">...</span><br><span class="line">   &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://csongyu.github.io/posts/aa4459bd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Song Yu Chen">
      <meta itemprop="description" content="日拱一卒，不期速成；道阻且长，行则将至">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="日拱一卒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/aa4459bd.html" class="post-title-link" itemprop="url">Health Indicator for Routing Data Source</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-12 00:00:00" itemprop="dateCreated datePublished" datetime="2023-02-12T00:00:00+08:00">2023-02-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a
target="_blank" rel="noopener" href="https://github.com/csongyu/health-indicator-routing-data-source.git">csongyu/health-indicator-routing-data-source</a></p>
<h3 id="db-unknown-status">DB Unknown Status</h3>
<p>当 <code>javax.sql.DataSource</code> 接口的实现类为
<code>org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource</code>
的子类时，调用 <code>/actuator/health</code> 接口返回 DB 的健康状态为
UNKNOWN。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="attr">&quot;details&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;db&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;diskSpace&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="attr">&quot;details&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">494384795648</span><span class="punctuation">,</span><span class="attr">&quot;free&quot;</span><span class="punctuation">:</span><span class="number">391930544128</span><span class="punctuation">,</span><span class="attr">&quot;threshold&quot;</span><span class="punctuation">:</span><span class="number">10485760</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>原因在于：</p>
<p><code>org.springframework.boot.actuate.autoconfigure.jdbc.DataSourceHealthIndicatorAutoConfiguration</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, DataSource&gt; <span class="title function_">filterDataSources</span><span class="params">(Map&lt;String, DataSource&gt; candidates)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (candidates == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Map&lt;String, DataSource&gt; dataSources = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">	candidates.forEach((name, dataSource) -&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(dataSource <span class="keyword">instanceof</span> AbstractRoutingDataSource)) &#123;</span><br><span class="line">			dataSources.put(name, dataSource);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="keyword">return</span> dataSources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>org.springframework.boot.actuate.jdbc.DataSourceHealthIndicator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doHealthCheck</span><span class="params">(Health.Builder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.dataSource == <span class="literal">null</span>) &#123;</span><br><span class="line">		builder.up().withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;unknown&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		doDataSourceHealthCheck(builder);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义-health-indicator">自定义 Health Indicator</h3>
<p>通过 <code>org.springframework.jdbc.core.JdbcTemplate</code> 执行
<code>SELECT 1 FROM DUAL</code> 语句检查 DB 的健康状态。</p>
<p><code>xyz.csongyu.healthindicator.RoutingDataSourceHealthIndicator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> AbstractRoutingDataSource.class.getDeclaredField(<span class="string">&quot;resolvedDataSources&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">final</span> Map&lt;Object, DataSource&gt; resolvedDataSources = (Map&lt;Object, DataSource&gt;)field.get(<span class="built_in">this</span>.dataSource);</span><br><span class="line">    <span class="built_in">this</span>.jdbcTemplates = resolvedDataSources.entrySet().stream()</span><br><span class="line">        .collect(Collectors.toMap(Map.Entry::getKey, entry -&gt; <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(entry.getValue())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;Health&gt; results = <span class="built_in">this</span>.jdbcTemplates.entrySet().stream().map(entry -&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jdbcTemplate.queryForObject(<span class="string">&quot;SELECT 1 FROM DUAL&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">return</span> Health.up().withDetail(<span class="string">&quot;dataSource&quot;</span>, entry.getKey()).build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> DataAccessException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down().withDetail(<span class="string">&quot;dataSource&quot;</span>, entry.getKey()).withException(e).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="attr">&quot;details&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;routingDataSource&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="attr">&quot;details&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;DATA_SOURCE_B&quot;</span><span class="punctuation">:</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="attr">&quot;DATA_SOURCE_A&quot;</span><span class="punctuation">:</span><span class="string">&quot;UP&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;diskSpace&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="attr">&quot;details&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">494384795648</span><span class="punctuation">,</span><span class="attr">&quot;free&quot;</span><span class="punctuation">:</span><span class="number">391919927296</span><span class="punctuation">,</span><span class="attr">&quot;threshold&quot;</span><span class="punctuation">:</span><span class="number">10485760</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://csongyu.github.io/posts/36bffe79.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Song Yu Chen">
      <meta itemprop="description" content="日拱一卒，不期速成；道阻且长，行则将至">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="日拱一卒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/36bffe79.html" class="post-title-link" itemprop="url">Apache HC Fluent API Hangs When Got Some 404</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-12 00:00:00" itemprop="dateCreated datePublished" datetime="2022-07-12T00:00:00+08:00">2022-07-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="jstack">jstack</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;pool-1-thread-1&quot;</span> <span class="comment">#19 prio=5 os_prio=0 cpu=4292.67ms elapsed=6105.93s tid=0x00007f7bb1a83670 nid=0x1f63b2 waiting on condition  [0x00007f7b748fa000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at jdk.internal.misc.Unsafe.park(java.base@17.0.1/Native Method)</span><br><span class="line">	- parking to <span class="built_in">wait</span> <span class="keyword">for</span>  &lt;0x00000000c7541680&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(java.base@17.0.1/LockSupport.java:341)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionNode</span>.block(java.base@17.0.1/AbstractQueuedSynchronizer.java:506)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool.unmanagedBlock(java.base@17.0.1/ForkJoinPool.java:3463)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool.managedBlock(java.base@17.0.1/ForkJoinPool.java:3434)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.await(java.base@17.0.1/AbstractQueuedSynchronizer.java:1623)</span><br><span class="line">	at org.apache.http.pool.AbstractConnPool.getPoolEntryBlocking(AbstractConnPool.java:393)</span><br><span class="line">	at org.apache.http.pool.AbstractConnPool.access<span class="variable">$300</span>(AbstractConnPool.java:70)</span><br><span class="line">	at org.apache.http.pool.AbstractConnPool<span class="variable">$2</span>.get(AbstractConnPool.java:253)</span><br><span class="line">	- locked &lt;0x00000000c89eb980&gt; (a org.apache.http.pool.AbstractConnPool<span class="variable">$2</span>)</span><br><span class="line">	at org.apache.http.pool.AbstractConnPool<span class="variable">$2</span>.get(AbstractConnPool.java:198)</span><br><span class="line">	at org.apache.http.impl.conn.PoolingHttpClientConnectionManager.leaseConnection(PoolingHttpClientConnectionManager.java:306)</span><br><span class="line">	at org.apache.http.impl.conn.PoolingHttpClientConnectionManager<span class="variable">$1</span>.get(PoolingHttpClientConnectionManager.java:282)</span><br><span class="line">	at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:190)</span><br><span class="line">	at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:186)</span><br><span class="line">	at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)</span><br><span class="line">	at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:110)</span><br><span class="line">	at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)</span><br><span class="line">	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)</span><br><span class="line">	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)</span><br><span class="line">	at org.apache.http.client.fluent.Request.internalExecute(Request.java:173)</span><br><span class="line">	at org.apache.http.client.fluent.Request.execute(Request.java:177)</span><br><span class="line">	at xyz.csongyu.smartinvesttask.configuration.FundOpenFundInfoEmTaskConfiguration.lambda$unitNetAssetValueRunner<span class="variable">$1</span>(FundOpenFundInfoEmTaskConfiguration.java:85)</span><br><span class="line">	at xyz.csongyu.smartinvesttask.configuration.FundOpenFundInfoEmTaskConfiguration$$Lambda<span class="variable">$567</span>/0x0000000800f074c0.get(Unknown Source)</span><br><span class="line">	at java.util.concurrent.CompletableFuture<span class="variable">$AsyncSupply</span>.run(java.base@17.0.1/CompletableFuture.java:1768)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@17.0.1/ThreadPoolExecutor.java:1136)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(java.base@17.0.1/ThreadPoolExecutor.java:635)</span><br><span class="line">	at java.lang.Thread.run(java.base@17.0.1/Thread.java:833)</span><br></pre></td></tr></table></figure>
<h3 id="code-example">Code Example</h3>
<p><a
target="_blank" rel="noopener" href="https://github.com/csongyu/apache-hc-fluent-api">csongyu/apache-hc-fluent-api</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> List&lt;Integer&gt; indexes = Stream.iterate(<span class="number">0</span>, item -&gt; item + <span class="number">1</span>).limit(<span class="number">101</span>).collect(Collectors.toList());  </span><br><span class="line"><span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">CompletableFuture.allOf(indexes.stream().map(index -&gt; CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Request.Get(<span class="string">&quot;http://127.0.0.1:8088/index/&quot;</span> + index).connectTimeout(<span class="number">1_000</span>).socketTimeout(<span class="number">5_000</span>)</span><br><span class="line">            .addHeader(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;application/json&quot;</span>).execute()</span><br><span class="line">            .saveContent(directory.resolve(index + <span class="string">&quot;.json&quot;</span>).toFile());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Files.exists(Paths.get(index + <span class="string">&quot;.json&quot;</span>));</span><br><span class="line">&#125;, executorService)).toArray(CompletableFuture[]::<span class="keyword">new</span>)).orTimeout(<span class="number">30</span>, TimeUnit.SECONDS).join();</span><br></pre></td></tr></table></figure>
<h3 id="default-pooling-connection-manager">Default Pooling Connection
Manager</h3>
<p><a
target="_blank" rel="noopener" href="https://www.javadoc.io/doc/org.apache.httpcomponents/fluent-hc/4.5.1/org/apache/http/client/fluent/Executor.html">Class
Executor</a></p>
<blockquote>
<p>A PoolingHttpClientConnectionManager with maximum 100 connections per
route and a total maximum of 200 connections is used internally.</p>
</blockquote>
<h3 id="how-to-fix">How to Fix</h3>
<p><a
target="_blank" rel="noopener" href="https://www.javadoc.io/doc/org.apache.httpcomponents/fluent-hc/4.5.1/org/apache/http/client/fluent/Executor.html#execute(org.apache.http.client.fluent.Request)">execute</a></p>
<blockquote>
<p>Please Note that response content must be processed or discarded
using Response.discardContent(), otherwise the connection used for the
request might not be released to the pool.</p>
</blockquote>
<p><a
target="_blank" rel="noopener" href="https://www.javadoc.io/doc/org.apache.httpcomponents/fluent-hc/4.5.1/org/apache/http/client/fluent/Response.html#discardContent()">discardContent</a></p>
<blockquote>
<p>Discards response content and deallocates all resources associated
with it.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    response = Request.Get(<span class="string">&quot;http://127.0.0.1:8088/index/&quot;</span> + index).connectTimeout(<span class="number">1_000</span>)</span><br><span class="line">        .socketTimeout(<span class="number">5_000</span>).addHeader(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;application/json&quot;</span>).execute();</span><br><span class="line">    response.saveContent(directory.resolve(index + <span class="string">&quot;.json&quot;</span>).toFile());</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// important</span></span><br><span class="line">        response.discardContent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://csongyu.github.io/posts/737c248d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Song Yu Chen">
      <meta itemprop="description" content="日拱一卒，不期速成；道阻且长，行则将至">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="日拱一卒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/737c248d.html" class="post-title-link" itemprop="url">使用 Docker Compose 运行 WordPress</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-27 02:00:00" itemprop="dateCreated datePublished" datetime="2022-06-27T02:00:00+08:00">2022-06-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="域名解析">域名解析</h3>
<table>
<thead>
<tr class="header">
<th>主机记录</th>
<th>记录类型</th>
<th>记录值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>blog</td>
<td>A</td>
<td>x.x.x.x</td>
</tr>
</tbody>
</table>
<h3 id="编辑-docker-compose.yml">编辑 docker-compose.yml</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/samples/wordpress/">Quickstart:
Compose and WordPress</a></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wordpress-db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mariadb:10.7</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/wordpress-db-data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MARIADB_RANDOM_ROOT_PASSWORD:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">      <span class="attr">MARIADB_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MARIADB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MARIADB_PASSWORD:</span> <span class="string">wordpress.123</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wordpress-network</span></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wordpress:5.9</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/wordpress-data:/var/www/html</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">wordpress-db</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress.123</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_NAME:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wordpress-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">wordpress-network:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">wordpress-network</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<h3 id="nginx-添加站点">Nginx 添加站点</h3>
<h4 id="conf.dblog.domain.conf">conf.d/blog.&lt;domain&gt;.conf</h4>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment"># Serve Content Over IPv4 and IPv6</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> blog.&lt;domain&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://wordpress:80;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="docker-compose.yml">docker-compose.yml</h4>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    networks:</span><br><span class="line">      - wordpress-<span class="attribute">network</span></span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  wordpress-network:</span><br><span class="line">    external: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="运行-wordpress">运行 WordPress</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br><span class="line"><span class="comment"># https://blog.&lt;domain&gt;/</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Song Yu Chen"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Song Yu Chen</p>
  <div class="site-description" itemprop="description">日拱一卒，不期速成；道阻且长，行则将至</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/csongyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;csongyu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Song Yu Chen</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
